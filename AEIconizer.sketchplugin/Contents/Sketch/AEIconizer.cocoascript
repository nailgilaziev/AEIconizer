// Sketch Plugin: AEIconizer (ctrl shift i)
// Source: github.com/tadija/AEIconizer

// iOS icon sizes
var iTunesSizes = [NSArray arrayWithObjects: 512, nil];
var iOSSizes = [NSArray arrayWithObjects: 83.5, 76, 72, 50, 60, 40, 29, nil];
var watchOSSizes = [NSArray arrayWithObjects: 98, 86, 27.5, 24, nil];
var wirelessInstallSizes = [NSArray arrayWithObjects: 57, nil];
var iconSizes = [NSArray arrayWithObjects: iTunesSizes, iOSSizes, watchOSSizes, wirelessInstallSizes, nil];

// iOS icon names
var artboardNames = [NSArray arrayWithObjects:
    "appicon24", "appicon24@2x", "appicon24@3x", 
    "appicon27.5", "appicon27.5@2x", "appicon27.5@3x", 
    "appicon29", "appicon29@2x", "appicon29@3x", 
    "appicon40", "appicon40@2x", "appicon40@3x",
    "appicon50", "appicon50@2x", "appicon50@3x",  
	"appicon57", "appicon57@2x", "appicon57@3x",    
    "appicon60", "appicon60@2x", "appicon60@3x", 
    "appicon72", "appicon72@2x", "appicon72@3x", 
    "appicon76", "appicon76@2x", "appicon76@3x", 
    "appicon83.5", "appicon83.5@2x", "appicon83.5@3x", 
    "appicon86", "appicon86@2x", "appicon86@3x", 
    "appicon98", "appicon98@2x", "appicon98@3x", 
    "appicon512", "appicon512@2x", nil];

function onRun(context) {
    var doc = context.document;
    if (originalIcon = handleSelection(context)) {
        if ([[originalIcon frame] width] == [[originalIcon frame] height]) {
            [originalIcon setName: "appiconOriginal"];
            removeExistingIcons(context);
            iconize(originalIcon);
            [[doc currentView] centerLayersInCanvas];
        } else {
            [doc showMessage:"Oops, icon artboard must have same width and height"];
        }
    }
}

function handleSelection(context) {
    var selection = context.selection;
    var doc = context.document;
    var iconArtboard;

    if([selection count] == 0) {
        if ([[[doc currentPage] artboards] count] == 1) {
            iconArtboard = [[[doc currentPage] artboards] firstObject];
        } else {
            [doc showMessage:"Oops, you have to select something"];
        }
    } else {
        var currentSelection = selection[0];
        if (currentSelection.className() == "MSArtboardGroup") {
            iconArtboard = currentSelection;
        } else {
            iconArtboard = [currentSelection parentArtboard];
            if (!iconArtboard) {
                [doc showMessage:"Oops, selection has to be inside artboard"];
            }
        }
        [currentSelection setIsSelected:false];
    }

    return iconArtboard
}

function removeExistingIcons(context) {
    var doc = context.document;
    var artboards = [[doc currentPage] artboards];
    var loop = [artboards objectEnumerator];
    while (artboard = [loop nextObject]) {
        var name = [artboard name];
        if ([artboardNames containsObject: name]) {
            [[doc currentPage] removeLayer:artboard];
        }
    }
}

function iconize(originalIcon) {
    var originalSize = [[originalIcon frame] width];
    var originalX = [[originalIcon absoluteRect] rulerX];
    var originalY = [[originalIcon absoluteRect] rulerY];

    var spacing = 40;
    var startX = originalX;
    var startY = originalY + originalSize + spacing;

    var allSizes = [iconSizes objectEnumerator];
    while (sizeArray = [allSizes nextObject]) {
        startX = createIconsWithSizes(sizeArray, originalIcon, startX, startY, spacing);
    }
}

function createIconsWithSizes(sizeArray, originalIcon, fromX, fromY, spacing) {
    iconsRowHeight = 0;
		maxX = 0

    var sizes = [sizeArray objectEnumerator];
    while (newSize = [sizes nextObject]) {
        var iconName = "appicon" + newSize;

        newX = fromX
        newY = fromY + iconsRowHeight;

        if (newSize >= 512) {
            // iTunesArtwork-512@2x
            var artwork2x = scaleIcon(originalIcon, (newSize * 2), iconName + "@2x");
            [[artwork2x absoluteRect] setRulerX:newX];
            [[artwork2x absoluteRect] setRulerY:newY];

            // iTunesArtwork-512
            var artwork1x = scaleIcon(originalIcon, newSize, iconName);
            [[artwork1x absoluteRect] setRulerX:newX + (newSize * 2) + spacing];
            [[artwork1x absoluteRect] setRulerY:newY];
			
			maxX = [[artwork1x absoluteRect] x] + [[artwork1x absoluteRect] width]			
        } else {
            // appiconSize@3x
            var icon3x = scaleIcon(originalIcon, newSize * 3, iconName + "@3x");
            [[icon3x absoluteRect] setRulerX:newX];
            [[icon3x absoluteRect] setRulerY:newY];

            // appiconSize@2x
            var icon2x = scaleIcon(originalIcon, newSize * 2, iconName + "@2x");
            [[icon2x absoluteRect] setRulerX:newX + (newSize * 3) + spacing];
            [[icon2x absoluteRect] setRulerY:newY];

            // appiconSize
            var icon1x = scaleIcon(originalIcon, newSize, iconName);
            [[icon1x absoluteRect] setRulerX:newX + (newSize * 3) + (newSize * 2) + (2 * spacing)];
            [[icon1x absoluteRect] setRulerY:newY];

			maxXRect = [[icon1x absoluteRect] x] + [[icon1x absoluteRect] width]
			if ( maxXRect > maxX) {
				maxX = maxXRect
			}			

            // create new row
            iconsRowHeight += (newSize * 3) + spacing;
        }
    }
	
	return maxX + (3 * spacing)
}

function scaleIcon(originalIcon, newSize, newName) {
    var newIcon = [originalIcon duplicate];

    var originalSize = [[originalIcon frame] width];
    var ratio = newSize / originalSize;
    [newIcon multiplyBy:ratio];

    [newIcon setName: newName];
    [newIcon select:true byExpandingSelection:true];

    return newIcon;
}
